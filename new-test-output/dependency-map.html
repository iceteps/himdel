<!DOCTYPE html>
<html>
<head>
  <title>Himdell Dependency Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Use CDN links instead of local files -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js">
    // Setup the tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(tabId + '-tab').classList.add('active');
      });
    });
    
    // Initialize the text-flow display
    const textFlowContainer = document.getElementById('text-flow');
    textFlowContainer.textContent = `flowchart LR
  %% Style definitions
  classDef component fill:#e1f5fe,stroke:#0288d1,color:#01579b
  classDef context fill:#fff9c4,stroke:#fbc02d,color:#f57f17
  classDef object fill:#e8f5e9,stroke:#43a047,color:#1b5e20
  classDef array fill:#f3e5f5,stroke:#8e24aa,color:#4a148c
  classDef map fill:#ffebee,stroke:#e53935,color:#b71c1c
  classDef multiConsumer fill:#ede7f6,stroke:#673ab7,color:#311b92,stroke-width:3px

  subgraph Components
  end

  subgraph MultiConsumedProps
  prop_generatecomponenthierarchy["["Prop: generateComponentHierarchy
(2 consumers)"]:::multiConsumer
  prop_generateapiintegration["["Prop: generateApiIntegration
(2 consumers)"]:::multiConsumer
  prop_generatedataflow["["Prop: generateDataFlow
(2 consumers)"]:::multiConsumer
  end

  %% Import relationships
  commander --> generate_map
  chalk --> generate_map
  index --> generate_map
  index --> generate_map
  logger --> generate_map
  fileutils --> generate_map
  parser --> analyzecontexts
  recast --> analyzecontexts
  logger --> analyzecontexts
  filecache --> analyzecontexts
  promises --> analyzecontexts
  parser --> analyzeimports
  recast --> analyzeimports
  logger --> analyzeimports
  filecache --> analyzeimports
  promises --> analyzeimports
  parser --> analyzeprops
  recast --> analyzeprops
  logger --> analyzeprops
  filecache --> analyzeprops
  promises --> analyzeprops
  analyzeimports --> index
  analyzecontexts --> index
  analyzeprops --> index
  workerpool --> index
  fast_glob --> index
  path --> index
  logger --> index
  promises --> index
  promises --> buildhtmlpage
  path --> buildhtmlpage
  enhancedmermaid --> buildhtmlpage
  path --> buildmermaid
  promises --> buildmermaid
  logger --> buildmermaid
  path --> detailedflowcharts
  promises --> detailedflowcharts
  logger --> detailedflowcharts
  path --> enhancedmermaid
  path --> index
  promises --> index
  logger --> index
  buildmermaid --> index
  detailedflowcharts --> index
  writemarkdown --> index
  buildhtmlpage --> index
  path --> structureflowcharts
  promises --> structureflowcharts
  logger --> structureflowcharts
  promises --> writemarkdown
  path --> writemarkdown
  enhancedmermaid --> writemarkdown
  workerpool --> fileanalyzer
  promises --> fileanalyzer
  parser --> fileanalyzer
  recast --> fileanalyzer
  promises --> filecache
  crypto --> filecache
  path --> filecache
  promises --> fileutils
  path --> fileutils
  chalk --> logger
  child_process --> mmdcwrapper
  promises --> mmdcwrapper
  path --> mmdcwrapper
  os --> mmdcwrapper
  logger --> mmdcwrapper
  workerpool --> workerpool
  path --> workerpool
  url --> workerpool
  logger --> workerpool
  %% Context relationships
  %% Props relationships
  analyzecontexts -->|props| analyzecontexts
  analyzeimports -->|props| analyzeimports
  analyzeprops -->|props| analyzeprops
  index -->|props| analyzecodebase
  index -->|props| identifymulticonsumed
  index -->|props| analyzefilestructure
  buildhtmlpage -->|props| buildhtmlpage
  buildmermaid -->|props| buildmermaid
  buildmermaid -->|props| extractmermaidblocks
  buildmermaid -->|props| buildhtml
  detailedflowcharts -->|props| generatedetailedflowcharts
  detailedflowcharts -->|props| generatecartflowcharts
  detailedflowcharts -->|props| generateauthflowcharts
  detailedflowcharts -->|props| generategenericcontextflowcharts
  detailedflowcharts -->|props| generateapiintegrationflowchart
  detailedflowcharts -->|props| generatedataflowoverview
  detailedflowcharts -->|props| generatecheckoutprocess
  enhancedmermaid -->|props| buildenhancedmermaid
  index -->|props| generateoutputs
  index -->|props| generatestructurediagrams
  index -->|props| generatecomponenthierarchy
  index -->|props| generateapiintegration
  index -->|props| generatedataflow
  index -->|props| generateindexstructure
  structureflowcharts -->|props| generatestructureflowcharts
  structureflowcharts -->|props| generatecontextflowchart
  structureflowcharts -->|props| getnodename
  writemarkdown -->|props| categorizefile
  writemarkdown -->|props| getcomponentname
  writemarkdown -->|props| writemarkdown
  fileanalyzer -->|props| analyze
  mmdcwrapper -->|props| generatepng
  mmdcwrapper -->|props| generatesubgraphviews
  mmdcwrapper -->|props| extractsubgraphcontent
  mmdcwrapper -->|props| extractrelatedconnections
  mmdcwrapper -->|props| preprocessmermaidforreadability
  mmdcwrapper -->|props| execasync
  workerpool -->|props| workerpool
  prop_generatecomponenthierarchy -.->|used by| index
  prop_generatecomponenthierarchy -.->|used by| structureflowcharts
  prop_generateapiintegration -.->|used by| index
  prop_generateapiintegration -.->|used by| structureflowcharts
  prop_generatedataflow -.->|used by| index
  prop_generatedataflow -.->|used by| structureflowcharts
  %% Object relationships
  %% Array relationships
  %% Map operations
  excludepatterns -->|mapped in| index
  files -->|mapped in| index
  authconsumers -->|mapped in| detailedflowcharts
  orderapis -->|mapped in| detailedflowcharts
  userapis -->|mapped in| detailedflowcharts
  productapis -->|mapped in| detailedflowcharts
`;
    
    // Setup PNG export
    document.getElementById('export-png').addEventListener('click', () => {
      const svg = document.querySelector('#graph svg');
      if (svg) {
        // Create a canvas element to convert SVG to PNG
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Create an image from the SVG
        const image = new Image();
        const svgData = new XMLSerializer().serializeToString(svg);
        const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(svgBlob);
        
        image.onload = () => {
          // Set canvas dimensions to match the SVG
          canvas.width = image.width;
          canvas.height = image.height;
          
          // Draw the image to the canvas
          ctx.drawImage(image, 0, 0);
          
          // Convert to PNG and trigger download
          const pngUrl = canvas.toDataURL('image/png');
          const a = document.createElement('a');
          a.href = pngUrl;
          a.download = 'dependency-map.png';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };
        
        image.src = url;
      }
    });
    
    // Setup fullscreen
    document.getElementById('fullscreen').addEventListener('click', () => {
      const graphContainer = document.getElementById('flowchart-tab');
      if (graphContainer.requestFullscreen) {
        graphContainer.requestFullscreen();
      } else if (graphContainer.mozRequestFullScreen) {
        graphContainer.mozRequestFullScreen();
      } else if (graphContainer.webkitRequestFullscreen) {
        graphContainer.webkitRequestFullscreen();
      } else if (graphContainer.msRequestFullscreen) {
        graphContainer.msRequestFullscreen();
      }
    });
  
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .controls {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .controls button {
      padding: 5px 10px;
      margin: 0 5px;
      cursor: pointer;
      background: #4a6ee0;
      color: white;
      border: none;
      border-radius: 3px;
    }
    
    #graph {
      overflow: auto;
      margin-top: 20px;
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      min-height: 400px;
    }
    
    #graph svg {
      transform-origin: top left;
      transition: transform 0.2s;
      width: 100%;
    }
    
    .mermaid {
      font-size: 16px;
    }
    
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    
    .legend {
      margin: 10px 0;
      padding: 10px;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
  
    #graph svg {
      width: auto !important;
      height: auto !important;
      max-width: 100%;
    }
    
    .svg-pan-zoom-control {
      display: block;
    }
    
    /* Tabs for switching between PNG and text views */
    .tabs {
      display: flex;
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-bottom: none;
      margin-right: 5px;
      border-radius: 5px 5px 0 0;
    }
    
    .tab.active {
      background: white;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 0 5px 5px 5px;
      background: white;
    }
    
    .tab-content.active {
      display: block;
    }
    
    #text-flow {
      font-family: monospace;
      white-space: pre;
      overflow-x: auto;
      line-height: 1.5;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 5px;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .flowchart-container {
      position: relative;
      margin-top: 20px;
    }
    
    /* Styling for the PNG export controls */
    .export-controls {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    
    .export-controls button {
      padding: 8px 15px;
      background: #4a6ee0;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    /* Legend styling */
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }
    
    .component-color { background-color: #e1f5fe; border: 1px solid #0288d1; }
    .context-color { background-color: #fff9c4; border: 1px solid #fbc02d; }
    .object-color { background-color: #e8f5e9; border: 1px solid #43a047; }
    .array-color { background-color: #f3e5f5; border: 1px solid #8e24aa; }
    .map-color { background-color: #ffebee; border: 1px solid #e53935; }
    .multi-color { background-color: #ede7f6; border: 1px solid #673ab7; border-width: 3px; }
  
  </style>
</head>
<body>
  <h1>Himdell Dependency Map</h1>
  
  <div class="legend">
    <p>This diagram shows the dependencies between files in your project.</p>
  </div>
  
  <!-- Error container -->
  <div id="error-container" style="color: red; margin-bottom: 10px;"></div>
  
  <!-- Controls for zooming -->
  <div class="controls">
    <button id="zoom-in">+</button>
    <button id="zoom-out">-</button>
    <button id="reset">Reset</button>
  </div>
  
  <div id="graph"></div>
  
  <script>
    // Initialize mermaid with better settings
    mermaid.initialize({ 
      startOnLoad: true,
      theme: 'default',
      securityLevel: 'loose',
      flowchart: {
        htmlLabels: true,
        curve: 'basis'
      }
    });
    
    try {
      // Render the mermaid diagram
      const mermaidCode = `flowchart LR
  %% Style definitions
  classDef component fill:#e1f5fe,stroke:#0288d1,color:#01579b
  classDef context fill:#fff9c4,stroke:#fbc02d,color:#f57f17
  classDef object fill:#e8f5e9,stroke:#43a047,color:#1b5e20
  classDef array fill:#f3e5f5,stroke:#8e24aa,color:#4a148c
  classDef map fill:#ffebee,stroke:#e53935,color:#b71c1c
  classDef multiConsumer fill:#ede7f6,stroke:#673ab7,color:#311b92,stroke-width:3px

  subgraph Components
  end

  subgraph MultiConsumedProps
  prop_generatecomponenthierarchy["["Prop: generateComponentHierarchy
(2 consumers)"]:::multiConsumer
  prop_generateapiintegration["["Prop: generateApiIntegration
(2 consumers)"]:::multiConsumer
  prop_generatedataflow["["Prop: generateDataFlow
(2 consumers)"]:::multiConsumer
  end

  %% Import relationships
  commander --> generate_map
  chalk --> generate_map
  index --> generate_map
  index --> generate_map
  logger --> generate_map
  fileutils --> generate_map
  parser --> analyzecontexts
  recast --> analyzecontexts
  logger --> analyzecontexts
  filecache --> analyzecontexts
  promises --> analyzecontexts
  parser --> analyzeimports
  recast --> analyzeimports
  logger --> analyzeimports
  filecache --> analyzeimports
  promises --> analyzeimports
  parser --> analyzeprops
  recast --> analyzeprops
  logger --> analyzeprops
  filecache --> analyzeprops
  promises --> analyzeprops
  analyzeimports --> index
  analyzecontexts --> index
  analyzeprops --> index
  workerpool --> index
  fast_glob --> index
  path --> index
  logger --> index
  promises --> index
  promises --> buildhtmlpage
  path --> buildhtmlpage
  enhancedmermaid --> buildhtmlpage
  path --> buildmermaid
  promises --> buildmermaid
  logger --> buildmermaid
  path --> detailedflowcharts
  promises --> detailedflowcharts
  logger --> detailedflowcharts
  path --> enhancedmermaid
  path --> index
  promises --> index
  logger --> index
  buildmermaid --> index
  detailedflowcharts --> index
  writemarkdown --> index
  buildhtmlpage --> index
  path --> structureflowcharts
  promises --> structureflowcharts
  logger --> structureflowcharts
  promises --> writemarkdown
  path --> writemarkdown
  enhancedmermaid --> writemarkdown
  workerpool --> fileanalyzer
  promises --> fileanalyzer
  parser --> fileanalyzer
  recast --> fileanalyzer
  promises --> filecache
  crypto --> filecache
  path --> filecache
  promises --> fileutils
  path --> fileutils
  chalk --> logger
  child_process --> mmdcwrapper
  promises --> mmdcwrapper
  path --> mmdcwrapper
  os --> mmdcwrapper
  logger --> mmdcwrapper
  workerpool --> workerpool
  path --> workerpool
  url --> workerpool
  logger --> workerpool
  %% Context relationships
  %% Props relationships
  analyzecontexts -->|props| analyzecontexts
  analyzeimports -->|props| analyzeimports
  analyzeprops -->|props| analyzeprops
  index -->|props| analyzecodebase
  index -->|props| identifymulticonsumed
  index -->|props| analyzefilestructure
  buildhtmlpage -->|props| buildhtmlpage
  buildmermaid -->|props| buildmermaid
  buildmermaid -->|props| extractmermaidblocks
  buildmermaid -->|props| buildhtml
  detailedflowcharts -->|props| generatedetailedflowcharts
  detailedflowcharts -->|props| generatecartflowcharts
  detailedflowcharts -->|props| generateauthflowcharts
  detailedflowcharts -->|props| generategenericcontextflowcharts
  detailedflowcharts -->|props| generateapiintegrationflowchart
  detailedflowcharts -->|props| generatedataflowoverview
  detailedflowcharts -->|props| generatecheckoutprocess
  enhancedmermaid -->|props| buildenhancedmermaid
  index -->|props| generateoutputs
  index -->|props| generatestructurediagrams
  index -->|props| generatecomponenthierarchy
  index -->|props| generateapiintegration
  index -->|props| generatedataflow
  index -->|props| generateindexstructure
  structureflowcharts -->|props| generatestructureflowcharts
  structureflowcharts -->|props| generatecontextflowchart
  structureflowcharts -->|props| getnodename
  writemarkdown -->|props| categorizefile
  writemarkdown -->|props| getcomponentname
  writemarkdown -->|props| writemarkdown
  fileanalyzer -->|props| analyze
  mmdcwrapper -->|props| generatepng
  mmdcwrapper -->|props| generatesubgraphviews
  mmdcwrapper -->|props| extractsubgraphcontent
  mmdcwrapper -->|props| extractrelatedconnections
  mmdcwrapper -->|props| preprocessmermaidforreadability
  mmdcwrapper -->|props| execasync
  workerpool -->|props| workerpool
  prop_generatecomponenthierarchy -.->|used by| index
  prop_generatecomponenthierarchy -.->|used by| structureflowcharts
  prop_generateapiintegration -.->|used by| index
  prop_generateapiintegration -.->|used by| structureflowcharts
  prop_generatedataflow -.->|used by| index
  prop_generatedataflow -.->|used by| structureflowcharts
  %% Object relationships
  %% Array relationships
  %% Map operations
  excludepatterns -->|mapped in| index
  files -->|mapped in| index
  authconsumers -->|mapped in| detailedflowcharts
  orderapis -->|mapped in| detailedflowcharts
  userapis -->|mapped in| detailedflowcharts
  productapis -->|mapped in| detailedflowcharts
`;
      mermaid.mermaidAPI.render('graph', mermaidCode, (svgCode) => {
        document.getElementById('graph').innerHTML = svgCode;
        
        // Setup zoom functionality
        const svg = document.querySelector('#graph svg');
        if (svg) {
          let zoom = 1;
          
          document.getElementById('zoom-in').addEventListener('click', () => {
            zoom += 0.1;
            svg.style.transform = `scale(${zoom})`;
          });
          
          document.getElementById('zoom-out').addEventListener('click', () => {
            if (zoom > 0.2) zoom -= 0.1;
            svg.style.transform = `scale(${zoom})`;
          });
          
          document.getElementById('reset').addEventListener('click', () => {
            zoom = 1;
            svg.style.transform = `scale(${zoom})`;
          });
        }
      });
    } catch (error) {
      document.getElementById('error-container').textContent = 'Error rendering graph: ' + error.message;
      console.error('Mermaid error:', error);
    }
  </script>
</body>
</html>